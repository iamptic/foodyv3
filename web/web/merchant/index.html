<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Foody — ЛК партнёра</title>
  <link rel="icon" href="/web/favicon.png"/>
  <script src="/config.js"></script>
  <style>
    :root{--bg:#f7f7f9;--fg:#111;--muted:#666;--card:#fff;--border:#e5e7eb;--btn:#111;--btnfg:#fff}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--fg);margin:0}
    header{display:flex;align-items:center;gap:8px;padding:14px 16px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0}
    header img{height:24px}
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:360px 1fr;gap:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;box-shadow:0 4px 16px rgba(0,0,0,.04)}
    h2{margin:0 0 12px 0;font-size:18px}
    label{font-size:12px;opacity:.9}
    input,textarea,select,button{font:inherit}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{background:var(--btn);color:var(--btnfg);border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .muted{font-size:12px;color:var(--muted)}
    .hidden{display:none !important}
    details{margin-top:12px}
    details>summary{cursor:pointer;color:#444}
    #toast{position:fixed;right:12px;bottom:12px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;display:none}
  </style>
</head>
<body>
<header>
  <img src="/web/logo.png" alt="Foody"/><b>Foody — ЛК партнёра</b>
  <div style="margin-left:auto"><button id="logout" class="btn">Выйти</button></div>
</header>

<div class="wrap">
  <div class="card" id="loginCard">
    <h2>Вход / Регистрация</h2>
<!-- PHONE LOGIN (DEV RECOVER) -->
    <div id="phoneLogin">
      <label>Телефон</label>
      <input id="loginPhone" placeholder="+7 ..." />
      <label class="muted">Секрет (временно, для MVP)</label>
      <input id="loginSecret" placeholder="RECOVERY_SECRET" />
      <div style="margin-top:10px"><button class="btn" id="btnLogin">Войти</button></div>
      <div class="muted" style="margin-top:8px">В проде заменим на вход по коду.</div>
    </div>

    <hr style="margin:16px -16px;border:0;border-top:1px solid #eee"/>

    <!-- SIMPLE REGISTRATION -->
    <div id="reg">
      <div class="row">
        <div><label>Название *</label><input id="regTitle" placeholder="Кафе «Вкусно»"></div>
        <div><label>Телефон</label><input id="regPhone" placeholder="+7 ..."></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Город</label><input id="regCity" placeholder="Город"></div>
        <div><label>Адрес</label><input id="regAddress" placeholder="Улица, дом"></div>
      </div>
      <div style="margin-top:8px"><button class="btn" id="btnGeo">Определить гео</button></div>
      <div class="muted" style="margin-top:6px">Маркер можно уточнить на карте после регистрации.</div>
      <div style="margin-top:10px"><button class="btn" id="btnRegister">Зарегистрировать</button></div>

      <details>
        <summary>Техвход (на случай, если /recover ещё не поднят)</summary>
        <div class="row" style="margin-top:8px">
          <div><label>RID</label><input id="rid"></div>
          <div><label>KEY</label><input id="key"></div>
        </div>
        <div style="margin-top:10px"><button class="btn" id="btnTechLogin">Войти по RID/KEY</button></div>
      </details>
    </div>
  </div>

  <div class="card" id="profileCard">
    <h2>Профиль</h2>
<div class='row'><div class='muted'>Пресеты скидок:</div>
<div style='display:flex;gap:8px;flex-wrap:wrap'>
<button class='btn' type='button' data-preset-discount='30'>−30%</button>
<button class='btn' type='button' data-preset-discount='50'>−50%</button>
<button class='btn' type='button' data-preset-discount='70'>−70%</button>
</div></div>
<div class='row'><div class='muted'>Сдвиг времени:</div>
<div style='display:flex;gap:8px;flex-wrap:wrap'>
<button class='btn' type='button' data-shift-hours='1'>+1 час</button>
<button class='btn' type='button' data-shift-hours='2'>+2 часа</button>
</div></div>
    <div class="row">
      <div><label>Название *</label><input id="pTitle" placeholder="Название"></div>
      <div><label>Телефон</label><input id="pPhone" placeholder="+7 ..."></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Адрес</label><input id="pAddress" placeholder="Улица, дом"></></div>
      <div><label>Город</label><input id="pCity" placeholder="Город"></div>
    </div>
    <!-- lat/lon скрыты из UI; значения берём из гео или профиля -->
    <div class="row hidden" id="latlonRow" style="margin-top:8px">
      <div><label>lat</label><input id="pLat"></div>
      <div><label>lon</label><input id="pLon"></div>
    </div>
    <div style="margin-top:10px"><button class="btn" id="btnSaveProfile">Сохранить профиль</button></div>
  </div>
</div>

<div id="toast"></div>

<script>
const API = window.FOODY_API || '';
function toast(s){ const t=document.getElementById('toast'); t.textContent=s; t.style.display='block'; setTimeout(()=>t.style.display='none',2200); }
function saveAuth(rid,key){ localStorage.setItem('RID',rid); localStorage.setItem('KEY',key); }
function auth(){ return {rid:localStorage.getItem('RID'), key:localStorage.getItem('KEY')} }

// Login via /merchant/recover (dev)
document.getElementById('btnLogin').onclick = async ()=>{
  const phone = document.getElementById('loginPhone').value.trim();
  const secret = document.getElementById('loginSecret').value.trim();
  try{
    const rs = await fetch(API+'/api/v1/merchant/recover', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone,secret})});
    if(!rs.ok){ const t=await rs.text(); throw new Error('Ошибка входа: '+t); }
    const j = await rs.json();
    saveAuth(j.restaurant_id, j.api_key);
    toast('Вход выполнен'); location.reload();
  }catch(e){ toast(e.message); }
};

// Tech login (fallback)
document.getElementById('btnTechLogin').onclick = ()=>{
  const rid=document.getElementById('rid').value.trim();
  const key=document.getElementById('key').value.trim();
  if(!rid||!key){ return toast('Укажите RID и KEY'); }
  saveAuth(rid,key); toast('Вход выполнен'); location.reload();
};

// Register
document.getElementById('btnRegister').onclick = async ()=>{
  const title=document.getElementById('regTitle').value.trim();
  const phone=document.getElementById('regPhone').value.trim();
  const city=document.getElementById('regCity').value.trim();
  const address=document.getElementById('regAddress').value.trim();
  try{
    const rs=await fetch(API+'/api/v1/merchant/register_public',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,phone,city,address})});
    if(!rs.ok){ const t=await rs.text(); throw new Error('Регистрация не удалась: '+t); }
    const j=await rs.json(); saveAuth(j.restaurant_id, j.api_key);
    toast('Готово, вы вошли'); location.reload();
  }catch(e){ toast(e.message); }
};

// Geo button
document.getElementById('btnGeo').onclick = ()=>{
  if(!navigator.geolocation){ return toast('Гео недоступно'); }
  navigator.geolocation.getCurrentPosition(pos=>{
    localStorage.setItem('GEO_LAT', pos.coords.latitude);
    localStorage.setItem('GEO_LON', pos.coords.longitude);
    toast('Гео сохранено');
  }, ()=> toast('Нет доступа к гео'));
};

// Save profile (uses auth RID/KEY from storage)
document.getElementById('btnSaveProfile').onclick = async ()=>{
  const {rid,key}=auth(); if(!rid||!key){ return toast('Сначала войдите'); }
  const title=document.getElementById('pTitle').value.trim();
  const phone=document.getElementById('pPhone').value.trim();
  const address=document.getElementById('pAddress').value.trim();
  const city=document.getElementById('pCity').value.trim();
  const lat = localStorage.getItem('GEO_LAT') || document.getElementById('pLat').value;
  const lon = localStorage.getItem('GEO_LON') || document.getElementById('pLon').value;
  try{
    const body={ restaurant_id:rid, title, phone, address, city, lat, lon };
    const rs=await fetch(API+'/api/v1/merchant/profile',{method:'POST',headers:{'Content-Type':'application/json','X-Foody-Key':key},body:JSON.stringify(body)});
    if(!rs.ok){ const t=await rs.text(); throw new Error('Не сохранилось: '+t); }
    toast('Профиль сохранён');
  }catch(e){ toast(e.message); }
};

// Logout
document.getElementById('logout').onclick = ()=>{ localStorage.removeItem('RID'); localStorage.removeItem('KEY'); location.reload(); };

// On load: hide login if token exists
(function init(){
  const {rid,key}=auth();
  if(rid && key){
    document.getElementById('loginCard').classList.add('hidden');
  }
  // Hide lat/lon row
  document.getElementById('latlonRow').classList.add('hidden');
})();
</script>
</body>
</html>

<script>
(function(){
  function on(el, ev, fn){ if(el) el.addEventListener(ev, fn); }
  function q(id){ return document.getElementById(id); }
  // Preset buttons expect inputs with ids: discount_percent, start_at, end_at
  const d = q('discount_percent');
  const start = q('start_at'); const end = q('end_at');
  const btns = document.querySelectorAll('[data-preset-discount]');
  btns.forEach(b => on(b, 'click', () => { if(d){ d.value = b.dataset.presetDiscount; d.dispatchEvent(new Event('input')); } }));
  const shiftBtns = document.querySelectorAll('[data-shift-hours]');
  function shift(val){
     function plusHours(iso, h){ try{ const t = new Date(iso||new Date().toISOString()); t.setHours(t.getHours()+val); return t.toISOString().slice(0,16); }catch(e){ return iso; } }
     if(start){ start.value = plusHours(start.value, val); }
     if(end){ end.value = plusHours(end.value, val); }
  }
  shiftBtns.forEach(b => on(b, 'click', () => shift(parseInt(b.dataset.shiftHours||'0',10))));
})();
</script>
